<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-ca2c2719-8a5d-4e52-be47-649c82cfe8b8"></attachment><p>Saas系统最近几年都很火。很多创业公司都在尝试创建企业级别的应用 cRM, HR,销售, Desk Saas系统。很多Saas创业公司也拿了大额风投。毕竟Saas相对传统软件的优势非常明显。&nbsp;&nbsp;</p><p><br></p><p>最近一年，有幸架构一个Crm saas 系统，上线了几个月来，各方面都比满意。整个系统创建过程，踩了很多坑，收获也比较多。总结一下Saas系统架构一些特点：</p><p><br></p><p>Saas系统分级：</p><p><br></p><p>SaaS系统架构成熟度模型的5个级别——从“混乱”到“乌托邦“</p><p><br></p><p>第0级（混乱）：每次新增一个客户，都会新增软件的一个实例。</p><p>第1级（受控的混乱）：所有客户都运行在软件的同一个版本上，而且任何的定制化都通过修改配置来实现。</p><p>第2级（多租户[multi-tenant]、高层建筑[Highrise]）：所有的客户都已经可以在软件的同一个版本上运行了，而且他们都在同一个“实例”上运行。</p><p>第3级（多租户， 扩建[Build-Out]）：此时你已经拥有了多租户、单一版本的软件模型。不过你还是可以通过硬件扩展（scale-out）的方式来进行扩充。</p><p>第4级（乌托邦）：如同第3级，除非你可以找出有效的方式，以在不同的“实例”上运行不同版本的软件。</p><p><br></p><p>应用程序必须支持多租户：</p><p><br></p><p>&nbsp;多租户可以分为几个不同的类别（如列表下方的图所示）：</p><p>&nbsp;1.1，云中的简单虚拟化，其中只对硬件进行共享。</p><p>&nbsp;1.2，共享应用程序，对每个租户使用不同的数据库。</p><p>&nbsp;1.3，共享应用程序和数据库（效率最高，真正的多租户）。</p><p><br></p><p>1.分层设计</p><p>Saas系统分层大概是：</p><p><br></p><p><br></p><p>Saas系统分层</p><p>&nbsp;</p><p><br></p><p>Saas系统分层：租户识别&gt;应用层&gt;数据访问层&gt;缓存层&gt;数据库</p><p><br></p><p>业务代码都是写在应用层。</p><p><br></p><p>租户识别可以用spring拦截器实现，然后使用ThreadLocal传递给后端</p><p><br></p><p>数据库和缓存层对应用层应该是透明的。程序员在写代码的时候，只关心业务逻辑，不应该担心多租户的问题。</p><p><br></p><p>&nbsp;</p><p>2.数据隔离要透明</p><p>saas系统说起来很简单，任何系统似乎加个tenant_id(租户id)就变成saas系统了。比如原来的用户登录是：</p><p><br></p><p>select username,password from users where email='abc@qq.com'</p><p>改成</p><p><br></p><p>select username,password from users where email='abc@qq.com' and tenant_id =1;</p><p>对于复杂业务的saas系统，这样做法非常危险，而且开发效率很低。你想想如果那个程序员写sql时候忘了加 “ and tenant_id =1” . 结果不堪设想。</p><p><br></p><p>比较好做法是在数据库访问层对SQL进行改写。</p><p><br></p><p>TenantContext.exec("select username,password from users where email='abc@qq.com' ");</p><p>在连接池根据TenatnContext改写Sql.&nbsp;</p><p><br></p><p>这样做好处是，一来程序猿最多把系统搞down了，也不至于信息串了互相泄露。二来将来做分表分库也很方便，上层应用不用修改。</p><p><br></p><p>3. 租户识别方案</p><p>比较好做法是通过url识别租户。系统是给租户生成一个随机的三级域名，比如 abc.crm.baidu.com.&nbsp;&nbsp;如果客户想使用自己的域名，可以在cname到我们生成的三级域名，并在管理系统里面做绑定。</p><p><br></p><p>这样一个租户可以有两个域名，访问saas,一个随机生成的三级域名，另外一个租户自己的域名.代码里面可以根据过来的域名，判断是那个租户然后初始化TenantContext.</p><p><br></p><p>如果不想通过域名来做，也可以通过登录名来判断。这种方式要涉及到租户切换问题。</p><p><br></p><p>4. 智能DNS</p><p>以后补充。</p><p><br></p><p>5. 租户管理系统（计费，订购，定制，充值，催缴）</p><p>Saas系统是必须考虑计费系统和租户控制系统。这个系统需要都是独立设计。比如那个租户购买了那些模块，一个月多少钱。租户可以创建最多的用户数。计费到期邮件提醒等功能。</p><p><br></p><p>计费方式一般有两种，周期性计费，类似月租方案，和使用量计费,用多少付多少。 周期性计费比较简单。也可以两者结合起来。</p><p><br></p><p>6. 定制化开发</p><p>SAAS的优势在于一套系统多人使用，似乎和定制化开发有冲突。比如A客户想要A功能，B客户不想要。但定制化开发是无法避免的，比如CRM系统这样复杂的系统，不可能一套系统满足所有公司的要求。定制化开发尽可能分系统，分模块去做。然后通过控制台中配置不同租户订购不同模块，那些模块可以在前端页面上显示。不同的子系统需要分开部署。前端可通过nginx根据url分发，比如 abc.crm.baidu.com/bi/xxx/xx这个地址，就分发到BI子系统。不要尝试OSGI去搞模块化，这个是个大坑。</p><p><br></p><p>还有开发和产品，现有需求一定要分析清楚，不要一上线发现后患无穷。新功能尽量做的独立可以配置。</p><p><br></p><p>7. 灰度升级</p><p>SAAS付费企业客户对系统问题都特别敏感。 为了减少升级可能出现问题的影响范围，一般都采用灰度升级策略。如果使用了url来区分不同租户，灰度升级配置就会很方便。可以配置nginx 来根据域名做分发，比如租户A（aaa.com）到实例1（版本1.0），租户B(bbb.com)到实例2(版本). 当需要域名配置非常多的时候，nginx配置文档会乱。这块时候可以考虑使用nignx_lua来写一些扩展模块。</p><p><br></p><p>8. 容量估计</p><p>&nbsp;</p><p><br></p><p>9. Saas平台架构分层分析</p><p>Saas平台架构需要完成从用户申请链接saas到用户对自己购买的功能模块的应用整个过程，用户用起saas看似简单快捷，但这个过程却需要saas平台架构默默完成的非常复杂的处理过程。通过对saas平台架构的了解，可以清晰的分化数据的处理过程，让用户也可以明白saas平台架构处理数据的优势。下面介绍：saas平台架构分为哪几部分。</p><p><br></p><p>&nbsp;</p><p><br></p><p>saas平台架构之呈现层：</p><p><br></p><p>saas平台架构的呈现层可以使用的客户端可能都浏览器或本地客户端。如果是浏览器则需要Web界面技术、交互技术等技术（如：HTMl5技术、CSS3技术、Ajax技术等）的支持，如果是软件客户端则需要远程桌面技术、软件交互技术等技术支持。</p><p><br></p><p>saas平台架构之调度层：</p><p><br></p><p>saas平台架构的调度层体现分布式系统的特性之一。调度层首先负责识别并通过AAA认证每个用户请求，然后根据业务处理器的负载、业务特征进行合理的调度。通过应用这样的架构SaaS平台可以横向扩展。此外在存储、缓存等方面为了满足平台的横向扩展需求，调度层也必须具有良好的可扩展性。</p><p><br></p><p>saas平台架构之业务层：</p><p><br></p><p>saas平台架构的业务层负责接收调度层转发过来的请求，而且还要通过对接受到的请求执行真正的业务逻辑。一般来说业务逻辑的执行使用一台服务器就够了。因此业务层实际是由一排对等的服务器组成的，每台服务器都执行相同的业务逻辑。</p><p><br></p><p>saas平台架构之数据层：</p><p><br></p><p>saas平台架构的数据库集群用于处理存储关系性很强并且对事务性要求很高的业务数据，这类数据目前还要用传统的数据库集群技术来解决，saas平台架构的数据库集群主要是根据业务特征制定数据拆分方案。同时分布式数据库用于存放海量但关系性不强的数据（如：用户的操作日志等）。</p><p><br></p><p>以上是对“Saas系统架构的思考，多租户Saas架构设计分析”的介绍，从saas平台架构处理数据可以看出saas平台的应用有很强的优势，如用户使用saas非常方便简单只要浏览器或本地客户端接口，saas平台处理数据要经过层层认证saas产品安全可靠，saas平台优化处理数据提高saas性能。</p><p><br></p><p>多租户Saas系统架构还应该满足以下需求：</p><p><br></p><p>编号	需求	描述</p><p>1	软件授权	云平台付费授权机制，可按时间、功能、数量等进行付费授权</p><p>2	组织入驻	允许组织主动申请加入平台</p><p>3	实名认证	个人实名认证、组织实名认证</p><p>4	资质审核	个人和组织的资质审核，如对获得的证书或荣誉进行审核</p><p>5	组织绑定	个人账户绑定组织，与组织建立关联关系</p><p>6	组织解绑	个人账户与组织进行解绑</p><p>7	账户注销	个人账户注销，并销毁所有个人资料和档案</p><p>8	统一登录	即 SSO</p><p>9	统一注册	提供统一的用户注册页面</p><p>部分资料整理自：</p><p>————————————————</p><p>版权声明：本文为CSDN博主「程序小小生」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。</p><p>原文链接：https://blog.csdn.net/cnpinpai/article/details/91967335</p><p><br></p>